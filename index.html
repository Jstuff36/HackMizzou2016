
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Webcam Test</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>       
    /*global navigator, $, atob, Blob, params*/
   var makeblob = function (dataURL) {
            var BASE64_MARKER = ';base64,';
            if (dataURL.indexOf(BASE64_MARKER) == -1) {
                var parts = dataURL.split(',');
                var contentType = parts[0].split(':')[1];
                var raw = decodeURIComponent(parts[1]);
                return new Blob([raw], { type: contentType });
            }
            var parts = dataURL.split(BASE64_MARKER);
            var contentType = parts[0].split(':')[1];
            var raw = window.atob(parts[1]);
            var rawLength = raw.length;

            var uInt8Array = new Uint8Array(rawLength);

            for (var i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }

            return new Blob([uInt8Array], { type: contentType });
        }
        
    function getEmotions(img){
        $.ajax({
            url: "https://api.projectoxford.ai/emotion/v1.0/recognize?",
            beforeSend: function(xhrObj){
                // Request headers
                xhrObj.setRequestHeader("Content-Type","application/octet-stream");
                xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key","4ca8bd58cdea473da3626b9a6bd209b8");
            },
            type: "POST",
            // Request body
            data: makeblob(img),
        })
        .done(function(data) {
            JSON.stringify(data);
            alert(JSON.stringify(data));
        })
        .fail(function() {
            alert("error");
        });
    }
    
    $(document).ready(
        function (){
        	 // Elements for taking the snapshot
            var canvas = document.getElementById('canvas');
            var context = canvas.getContext('2d');
            var video = document.getElementById('video');
            
            // Get access to the camera!
            if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // Not adding `{ audio: true }` since we only want video now
                navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
                 video.src = window.URL.createObjectURL(stream);
                 video.play();
                 console.dir(video)
                });
            }
						console.log("Smile!")
        
            // Trigger photo take
            document.getElementById("snap").addEventListener("click", function() {
               context.drawImage(video, 0, 0, 640, 480);
               getEmotions(canvas.toDataURL('image/jpeg'));
            });
        });
        // $.ajax({
        //     url: 'https://api.projectoxford.ai/vision/v1/ocr?' + $.param(params),
        //     type: 'POST',
        //     processData: false,
        //     contentType: 'application/octet-stream',
        //     data: img
        // })
        // .done(function(data) {alert("success");})
        // .fail(function() {alert("error");});
        
      
    </script>
</head>
    <body>
        <video id="video" width="640" height="480" autoplay></video>
        <button id="snap">Snap Photo</button>
        <canvas id="canvas" width="640" height="480"></canvas>
    </body>
</html>